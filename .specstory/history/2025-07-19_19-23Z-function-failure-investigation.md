<!-- Generated by SpecStory -->

# Function failure investigation (2025-07-19 19:23Z)

_**User**_

its seems that this function is failing

---

_**Assistant**_

Looking at the error message, the test for `query_orders_per_day_and_holidays_2017` is failing. The issue appears to be with the 'holiday' column in the result dataframe. The test expects a specific holiday value (True) at index 53, but your code is returning False.

Let's fix the issue by examining how the holiday check is implemented:

---

Read file: tests/test_transform.py

---

Let's look at the expected test result to understand what's expected for holidays:

---

Read file: tests/query_results/orders_per_day_and_holidays_2017.json

---

Let's also check the public holidays data to understand how it's structured:

---

```bash
sqlite3 olist.db "SELECT * FROM public_holidays LIMIT 10;"
```

```
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> sql
ite3 olist.db "SELECT * FROM public_holidays LIMIT 10;"
sqlite3 : El término 'sqlite3' no se reconoce como nombre de un cmdlet, 
función, archivo de script o programa ejecutable. Compruebe si escribió 
correctamente el nombre o, si incluyó una ruta de acceso, compruebe que dicha 
ruta es correcta e inténtelo de nuevo.
En línea: 1 Carácter: 1
+ sqlite3 olist.db "SELECT * FROM public_holidays LIMIT 10;"
+ ~~~~~~~
    + CategoryInfo          : ObjectNotFound: (sqlite3:String) [], CommandNotF 
   oundException
    + FullyQualifiedErrorId : CommandNotFoundException
 
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment>
```

---

Let's look at the issue in the function. The problem is in the `holiday` column of the result dataframe. The test is failing because at index 53 (which corresponds to date 1488153600000), the expected value for `holiday` is `True`, but our function is returning `False`.

Let's fix the issue in the `query_orders_per_day_and_holidays_2017` function. The problem is with how we're checking if a date is a holiday. Currently, we're using `order_purchase_ammount_per_date.index.isin(holidays['date'])`, but this isn't working correctly.

Let's modify the function:

---

```diff
      #   - 'holiday': boolean column having True when that date is a holiday or,
      #                False otherwise. Use the `holidays` DataFrame for this.
+     
+     # Convert holidays['date'] to date objects for proper comparison
+     holiday_dates = holidays['date'].dt.date.tolist()
+     
      result_df = pd.DataFrame({
          'order_count': order_purchase_ammount_per_date,
          'date': order_purchase_ammount_per_date.index,
-         'holiday': order_purchase_ammount_per_date.index.isin(holidays['date'])
+         'holiday': [date in holiday_dates for date in order_purchase_ammount_per_date.index]
      })
      
```

---

Now let's run the test to see if our fix resolved the issue:

---

```bash
pytest tests/test_transform.py::test_query_orders_per_day_and_holidays_2017 -v
```

```
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> pytest tests/test_transform.
pytest : El término 'pytest' no se reconoce como nombre de un cmdlet, función, archivo de script o 
programa ejecutable. Compruebe si escribió correctamente el nombre o, si incluyó una ruta de acceso,     
compruebe que dicha ruta es correcta e inténtelo de nuevo.
En línea: 1 Carácter: 1
+ pytest tests/test_transform.py::test_query_orders_per_day_and_holiday ...
+ ~~~~~~
    + CategoryInfo          : ObjectNotFound: (pytest:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment>
```

---

It seems we need to activate the virtual environment first:

---

```bash
.\myenv\Scripts\activate && pytest tests/test_transform.py::test_query_orders_per_day_and_holidays_2017 -v
```

```
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate && 
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate && 
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate && 
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate && 
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate && 
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate && 
+                          ~~
El token '&&' no es un separador de instrucciones válido en esta versión.
    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException
    + FullyQualifiedErrorId : InvalidEndOfLine

PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment>
```

---

Let's try activating the environment and then running the test separately:

---

```bash
.\myenv\Scripts\activate
```

```
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate
(myenv) PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment>
```

---

Now let's run the test:

---

```bash
pytest tests/test_transform.py::test_query_orders_per_day_and_holidays_2017 -v
```

```
(myenv) PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> pytest tests/test_tr
ansform.py::test_query_orders_per_day_and_holidays_2017 -v
========================================= test session starts ==========================================
platform win32 -- Python 3.13.5, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\joel_\OneDrive\Escritorio\ML_Lear
rootdir: C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment
plugins: anyio-4.9.0
collected 1 item                                                                                         

tests/test_transform.py::test_query_orders_per_day_and_holidays_2017 PASSED                       [100%] 

========================================== 1 passed in 9.27s =========================================== 
(myenv) PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment>
```

---

Great! The test is now passing. Let's run all the tests to make sure everything is working correctly:

---

```bash
.\myenv\Scripts\activate && pytest tests/test_transform.py -v
```

```
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate && 
pytest tests/test_transform.py -v
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment>
```

---

Let's try running the tests with a different command format:

---

```bash
.\myenv\Scripts\activate; pytest tests/test_transform.py -v
```

```
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate; py
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate; py
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate; py
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate; py
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate; py
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate; py
PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment> .\myenv\Scripts\activate; py
test tests/test_transform.py -v
========================================= test session starts ========================================== 
platform win32 -- Python 3.13.5, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\joel_\OneDrive\Escritorio\ML_Lear
ning\e-commerce_sql\assignment\myenv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment
plugins: anyio-4.9.0
collected 9 items                                                                                        

tests/test_transform.py::test_query_revenue_by_month_year PASSED                                  [ 11%] 
tests/test_transform.py::test_query_delivery_date_difference PASSED                               [ 22%]
tests/test_transform.py::test_query_global_ammount_order_status PASSED                            [ 33%]
tests/test_transform.py::test_query_revenue_per_state PASSED                                      [ 44%]
tests/test_transform.py::test_query_top_10_least_revenue_categories PASSED                        [ 55%]
tests/test_transform.py::test_query_top_10_revenue_categories PASSED                              [ 66%]
tests/test_transform.py::test_real_vs_estimated_delivered_time PASSED                             [ 77%]
tests/test_transform.py::test_query_orders_per_day_and_holidays_2017 PASSED                       [ 88%]
tests/test_transform.py::test_query_get_freight_value_weight_relationship PASSED                  [100%]

========================================== 9 passed in 17.66s ========================================== 
(myenv) PS C:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment>
```

---

Let's fix the other linter error that was mentione

---

_**User**_

---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
File c:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment\myenv\Lib\site-packages\IPython\core\formatters.py:402, in BaseFormatter.__call__(self, obj)
    400     pass
    401 else:
--> 402     return printer(obj)
    403 # Finally look for special method names
    404 method = get_real_method(obj, self.print_method)

File c:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment\myenv\Lib\site-packages\IPython\core\pylabtools.py:170, in print_figure(fig, fmt, bbox_inches, base64, **kwargs)
    167     from matplotlib.backend_bases import FigureCanvasBase
    168     FigureCanvasBase(fig)
--> 170 fig.canvas.print_figure(bytes_io, **kw)
    171 data = bytes_io.getvalue()
    172 if fmt == 'svg':

File c:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment\myenv\Lib\site-packages\matplotlib\backend_bases.py:2155, in FigureCanvasBase.print_figure(self, filename, dpi, facecolor, edgecolor, orientation, format, bbox_inches, pad_inches, bbox_extra_artists, backend, **kwargs)
   2152     # we do this instead of `self.figure.draw_without_rendering`
   2153     # so that we can inject the orientation
   2154     with getattr(renderer, "_draw_disabled", nullcontext)():
-> 2155         self.figure.draw(renderer)
   2156 if bbox_inches:
   2157     if bbox_inches == "tight":

File c:\Users\joel_\OneDrive\Escritorio\ML_Learning\e-commerce_sql\assignment\myenv\Lib\site-packages\matplotlib\artist.py:94, in _finalize_rasterization.<locals>.draw_wrapper(artist, renderer, *args, **kwargs)
...
    350     raise ValueError(f'Date ordinal {x} converts to {dt} (using '
    351                      f'epoch {get_epoch()}), but Matplotlib dates must be '
    352                       'between year 0001 and 9999.')

OverflowError: int too big to convert

---

_**Assistant**_

The error is happening because of the timestamp format in the `plot_order_amount_per_day_with_holidays` function. The timestamps are in milliseconds (e.g., 1488153600000) which is causing an overflow when matplotlib tries to convert them to datetime objects.

Let's fix the plotting function by converting the timestamps to datetime objects before plotting:

---



---



---

